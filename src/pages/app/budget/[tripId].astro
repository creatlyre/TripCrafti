---
import Layout from "../../../layouts/Layout.astro";

import BudgetDashboard from "../../../components/budget/BudgetDashboard.tsx";
import { getDictionary } from "../../../lib/i18n";

export const prerender = false;

const { tripId } = Astro.params;
const lang = Astro.locals.lang;
const dict = getDictionary(lang).budget!;
let trip = null;
if (tripId && Astro.locals.supabase) {
    const { data } = await Astro.locals.supabase.from('trips').select('*').eq('id', tripId).single();
    trip = data;
}
---

<Layout title={trip ? dict.page.titleForTrip.replace('{title}', trip.title) : dict.page.titleBase}>
    <div class="relative bg-gradient-to-br from-brand-navy via-brand-navy-dark to-brand-navy min-h-screen">
        <div class="pointer-events-none absolute inset-0 bg-[radial-gradient(circle_at_20%_30%,rgba(78,216,216,0.15),rgba(10,25,47,0)_50%),radial-gradient(circle_at_80%_20%,rgba(255,154,82,0.12),rgba(10,25,47,0)_50%),radial-gradient(circle_at_40%_80%,rgba(78,216,216,0.08),rgba(10,25,47,0)_40%)]"></div>
        <div class="pointer-events-none absolute inset-0 bg-[linear-gradient(45deg,rgba(78,216,216,0.02)_1px,transparent_1px),linear-gradient(-45deg,rgba(255,154,82,0.02)_1px,transparent_1px)] bg-[size:60px_60px]"></div>
        <div class="container mx-auto px-4 py-8 space-y-8 relative">
        <nav class="text-sm text-brand-cyan/80 flex items-center gap-2 bg-brand-navy-light/30 backdrop-blur-sm px-4 py-2 rounded-lg border border-brand-cyan/20" aria-label="Breadcrumb">
            <a href="/app" class="hover:text-brand-cyan transition-colors font-medium">üè† {dict.page.breadcrumb.dashboard}</a>
            <span class="text-brand-cyan/50">‚Üí</span>
            <span class="text-brand-cyan font-semibold">üí∞ {dict.page.breadcrumb.budget}</span>
        </nav>
                {trip ? (
                    <>
                        <div class="rounded-2xl border-2 border-brand-cyan/20 bg-gradient-to-br from-brand-navy-light/90 to-brand-navy-lighter/90 backdrop-blur-lg shadow-2xl shadow-brand-cyan/5 p-6 md:p-8">
                          <div class="flex items-center justify-between mb-8">
                                      <h1 class="text-2xl md:text-3xl font-bold tracking-tight text-white flex items-center gap-3">
                                          üìä {dict.page.overview}
                                      </h1>
                                      {trip?.currency && <span class="text-sm px-4 py-2 rounded-lg bg-brand-cyan/10 border-2 border-brand-cyan/30 text-brand-cyan font-semibold shadow-lg">{dict.page.baseCurrency} {trip.currency}</span>}
                          </div>
                          <div class="relative">
                            <div class="animate-pulse space-y-8 md:hidden" id="budget-skeleton">
                                <div class="h-8 w-48 bg-brand-navy-lighter/60 rounded-lg"/>
                                <div class="h-40 bg-brand-navy-lighter/40 rounded-xl"/>
                                <div class="h-40 bg-brand-navy-lighter/40 rounded-xl"/>
                            </div>
                            <BudgetDashboard client:load trip={trip} lang={lang} />
                          </div>
                        </div>
                        <script is:inline>
                            // Remove skeleton once React mounts (rudimentary hydration hook)
                            window.addEventListener('DOMContentLoaded', () => {
                                queueMicrotask(()=>{
                                    const sk = document.getElementById('budget-skeleton');
                                    if (sk) sk.remove();
                                });
                            });
                        </script>
                    </>
                ) : (
                <div class="max-w-md mx-auto mt-12 text-center border border-brand-orange/30 bg-brand-orange/5 rounded-xl p-8 backdrop-blur-sm">
                    <div class="w-12 h-12 mx-auto mb-4 rounded-full bg-brand-orange/20 flex items-center justify-center">
                        <svg class="w-6 h-6 text-brand-orange" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    </div>
                    <h2 class="text-lg font-semibold mb-2 text-white">{dict.page.notFound.heading}</h2>
                    <p class="text-sm text-brand-cyan/80 mb-6">{dict.page.notFound.body}</p>
                    <a href="/app" class="inline-flex items-center gap-2 text-sm px-4 py-2 rounded-lg border border-brand-cyan/40 text-brand-cyan hover:bg-brand-cyan/10 transition">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                        {dict.page.notFound.back}
                    </a>
                </div>
            )}
        </div>
    </div>
</Layout>
